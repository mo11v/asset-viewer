<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙˆÙ„ - Asset Viewer</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* ------------------------------------------------------------------------------------------------
     * ğŸ¨ ØªØµÙ…ÙŠÙ… Ø­Ø¯ÙŠØ« ÙˆÙ…Ø­Ø³Ù†
     * ------------------------------------------------------------------------------------------------ */
    :root{
      /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
      --color-bg: #f5f8fc;
      --color-card: #ffffff;
      --color-primary: #0b66ff; /* Ø£Ø²Ø±Ù‚ Ø£Ø³Ø§Ø³ÙŠ */
      --color-primary-dark: #0747a6;
      --color-text: #1f2937;
      --color-muted: #6b7280;
      --color-border: #e2e8f0;
      
      /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø© */
      --color-success: #10b981; /* Ø£Ø®Ø¶Ø± */
      --color-warn: #f59e0b;   /* Ø£ØµÙØ± */
      --color-danger: #ef4444;  /* Ø£Ø­Ù…Ø± */
      
      /* ØªØ£Ø«ÙŠØ±Ø§Øª */
      --shadow-sm: 0 4px 12px rgba(0,0,0,0.06);
      --shadow-md: 0 10px 30px rgba(0,0,0,0.08);
      --radius: 12px;
      
      font-family: "Tajawal", Tahoma, Arial, sans-serif;
    }
    
    /* --- Reset / Base --- */
    *{box-sizing:border-box}
    html,body{height:100%;background:var(--color-bg);margin:0;padding:20px;color:var(--color-text)}
    .center{max-width:1024px;margin:20px auto;padding:10px;}
    .card{
      background:var(--color-card);
      border-radius:var(--radius);
      box-shadow:var(--shadow-md);
      overflow:hidden;
      border: 1px solid var(--color-border);
    }

    /* ---------------------- Header - Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ---------------------- */
    header{
      display:flex;align-items:center;gap:15px;padding:20px 25px;
      /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ (Glassmorphism) */
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(5px);
      border-bottom:1px solid var(--color-border);
      position: sticky; top: 0; z-index: 10;
    }
    .logo{
      width:60px;height:60px;border-radius:12px;
      background:linear-gradient(135deg,var(--color-primary),var(--color-primary-dark));
      display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:24px;flex-shrink:0;
      box-shadow: 0 5px 15px rgba(11,102,255,0.3);
    }
    header h1{font-size:20px;margin:0;color:var(--color-primary-dark);font-weight:800}
    header p{margin:0;color:var(--color-muted);font-size:14px}
    header .icon{font-size: 20px;}

    /* ---------------------- Content Layout - ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ---------------------- */
    .grid{display:grid;grid-template-columns: 1fr 380px;gap:20px;padding:20px}
    @media(max-width:1000px){ 
      .grid{grid-template-columns:1fr} 
      .side{order:1;border-left:none;border-bottom:1px solid var(--color-border);padding-bottom:20px} 
      .main{order:2} 
    }

    /* ---------------------- Main Column - Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---------------------- */
    .main {padding:15px}
    .asset-title{display:flex;align-items:center;gap:15px;flex-wrap:wrap}
    .asset-title h2{margin:0;font-size:24px;color:var(--color-text);font-weight:800}
    
    .badge{
      padding:8px 14px;border-radius:999px;font-weight:700;font-size:14px;color:#fff;white-space:nowrap;
      box-shadow: var(--shadow-sm);
    }
    .badge.green{background:var(--color-success)}
    .badge.yellow{background:var(--color-warn);color:#1f1f1f}
    .badge.red{background:var(--color-danger)}

    .meta-row{display:grid;grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));gap:15px;margin-top:20px}
    .meta{
      background:var(--color-bg);
      padding:15px;border-radius:var(--radius);
      box-shadow:var(--shadow-sm);
      border: 1px solid var(--color-border);
    }
    .meta b{display:block;color:var(--color-primary-dark);margin-bottom:6px;font-weight:700;font-size:15px}
    .meta .small{word-break:break-word;font-weight:600;color:var(--color-text)}
    
    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª */
    .components{margin-top:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px}

    .comp-item{
      padding:15px;border-radius:var(--radius);
      background:var(--color-card);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      box-shadow:var(--shadow-sm);
      border-left: 5px solid; /* Ø´Ø±ÙŠØ· Ø¬Ø§Ù†Ø¨ÙŠ Ù…ØªØºÙŠØ± */
    }
    .comp-item.green{border-color:var(--color-success);}
    .comp-item.yellow{border-color:var(--color-warn);}
    .comp-item.red{border-color:var(--color-danger);}

    .comp-item .name{color:var(--color-text);font-weight:700;word-break:break-word;font-size:16px}
    .comp-item .state{font-weight:800;padding:6px 12px;border-radius:8px;font-size:14px;white-space:nowrap;color:#fff;}
    .comp-item .state.green{background:var(--color-success);}
    .comp-item .state.yellow{background:var(--color-warn);color:var(--color-text);}
    .comp-item .state.red{background:var(--color-danger);}
    .comp-item .icon {color: var(--color-muted); font-size: 20px;}

    /* ---------------------- Side Column - Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ---------------------- */
    .side{padding:15px;border-left:1px solid var(--color-border)}
    @media(max-width:1000px){ .side{border-left:none} }
    
    .photo{
      border-radius:var(--radius);overflow:hidden;border:1px solid var(--color-border);
      background:linear-gradient(180deg,#f8fbfd,#fff);
      box-shadow:var(--shadow-sm);
      cursor: pointer; /* Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø£Ù† Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø± */
    }
    .photo img{width:100%;height:300px;object-fit:cover;display:block;transition: transform 0.3s;}
    .photo img:hover{transform: scale(1.02);}
    
    .actions{margin-top:15px;display:grid;gap:10px}
    .btn{
      display:inline-block;text-align:center;padding:14px;border-radius:10px;text-decoration:none;font-weight:800;
      box-shadow:0 8px 20px rgba(2,6,23,0.06);transition:all 0.3s;cursor:pointer;border:none;
      font-size: 16px;
    }
    .btn:hover{transform:translateY(-3px);box-shadow:0 12px 24px rgba(2,6,23,0.12)}
    .btn.primary{background:var(--color-primary);color:#fff}
    .btn.ghost{
      background:transparent;border:2px solid var(--color-border);color:var(--color-text);
      box-shadow:none;
    }
    .btn.green{background:var(--color-success);color:#fff}
    .btn.video{
      background:linear-gradient(90deg,#ff4d4d,#ff914d);color:#fff;
      box-shadow: 0 8px 20px rgba(255, 77, 77, 0.4);
    }
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important;box-shadow:none!important}
    .btn .icon {margin-left: 8px;}


    /* ---------------------- Small Table Area - Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ---------------------- */
    .table{
      margin-top:20px;border-radius:var(--radius);overflow:hidden;
      border:1px solid var(--color-border);
      background:var(--color-card);
      box-shadow:var(--shadow-sm);
    }
    .table-row{display:flex;gap:10px;padding:12px 15px;border-bottom:1px solid #f6f9fd;align-items:center}
    .table-row:last-child{border-bottom:none}
    .col-title{width:180px;color:var(--color-muted);font-weight:700;flex-shrink:0;font-size:14px}
    .col-val{flex:1;color:var(--color-text);font-weight:600;word-break:break-word}
    .col-val a{color:var(--color-primary);text-decoration:none;font-weight:700}
    .col-val a:hover{text-decoration:underline}

    /* ---------------------- Loading / Errors - Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø£Ø®Ø·Ø§Ø¡ ---------------------- */
    .loader{padding:40px;text-align:center;color:var(--color-muted);font-size:16px;font-weight:600;}
    .small{font-size:14px;color:var(--color-muted)}
    
    /* ---------------------- Modal Image Viewer - Ø¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ ---------------------- */
    .modal {
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(6,10,20,0.9);z-index:9999;padding:20px;
    }
    .modal.open{display:flex}
    .modal .box{max-width:90vw;width:100%;max-height:90vh;background:transparent;display:flex;flex-direction:column;gap:15px;align-items: center;}
    .modal img{
      width:auto; max-width:100%; height:auto; max-height:80vh; 
      border-radius:var(--radius);object-fit:contain;
      box-shadow:0 10px 40px rgba(2,6,23,0.5);background:#fff;
    }
    .modal .close{
      align-self: flex-end; /* ÙˆØ¶Ø¹ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© */
      background:var(--color-card);color:var(--color-text);
      padding:10px 18px;border-radius:8px;cursor:pointer;font-weight:700;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
      border: 1px solid var(--color-border);
    }
    .modal .close:hover{background:#f0f0f0}

    /* ---------------------- Footer - Ø§Ù„ØªØ°ÙŠÙŠÙ„ ---------------------- */
    footer{margin-top:20px;padding:10px;text-align:center;color:var(--color-muted);font-size:13px}

    /* ---------------------- Animations - ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø­Ø±ÙƒØ© ---------------------- */
    @keyframes fadeIn {
      from {opacity:0;transform:translateY(15px)}
      to {opacity:1;transform:translateY(0)}
    }
    .main, .side{animation:fadeIn 0.5s ease-out}
  </style>
</head>
<body>
  <div class="center">
    <div class="card">
      <header>
        <div class="logo">AS</div>
        <div>
          <h1>Ù†Ø¸Ø§Ù… Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙˆÙ„ <span class="icon">ğŸ’»</span></h1>
          <p class="small">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙÙ‚Ø±Ø£ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Google Sheets - ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… ?id=Ø±Ù‚Ù…_Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</p>
        </div>
      </header>

      <div class="grid">
        <div class="main" style="display:none">
          <div id="mainArea">
            <div class="asset-title">
              <h2 id="assetTitle">--</h2>
              <div id="statusBadge" class="badge yellow">--</div>
            </div>

            <div class="meta-row">
              <div class="meta"><b><span class="icon">#</span> Ø§Ù„Ø±Ù‚Ù… (Unit)</b><div id="metaUnit" class="small">--</div></div>
              <div class="meta"><b><span class="icon">ğŸ“</span> Ø§Ù„Ù…ÙˆÙ‚Ø¹</b><div id="metaLocation" class="small">--</div></div>
              <div class="meta"><b><span class="icon">ğŸ—“ï¸</span> Ø¢Ø®Ø± ÙØ­Øµ</b><div id="metaLast" class="small">--</div></div>
            </div>

            <h3 style="margin-top: 25px; margin-bottom: 10px; color: var(--color-primary-dark); font-weight: 700;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª <span class="icon">âš™ï¸</span></h3>
            <div class="components" id="componentsArea">
              </div>
            
            <h3 style="margin-top: 25px; margin-bottom: 10px; color: var(--color-primary-dark); font-weight: 700;">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© <span class="icon">ğŸ“„</span></h3>
            <div class="table" id="tableArea" style="display:none">
              </div>
            
          </div>
        </div>

        <aside class="side" style="display:none">
          <div class="photo">
            <img id="assetPhoto" src="" alt="Asset image" title="Ø§Ø¶ØºØ· Ù„Ù„ØªÙƒØ¨ÙŠØ±" 
            onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22320%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23f3f7fb%22 /><text x=%2250%25%22 y=%2250%25%22 fill=%22%239aa6b2%22 font-size=%2218%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</text></svg>'" />
          </div>

          <div class="actions">
            <button id="openChecklist" class="btn primary"><span class="icon">ğŸ“‹</span> Ø¹Ø±Ø¶ Checklist</button>
            <button id="openRig" class="btn green"><span class="icon">ğŸ—ï¸</span> Ø¹Ø±Ø¶ Rig Site</button>
            <a id="openVideo" class="btn video" href="#" target="_blank" style="display:none"><span class="icon">â–¶ï¸</span> ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>
            <a id="openExternal" class="btn ghost" href="#" target="_blank"><span class="icon">ğŸ”—</span> ÙØªØ­ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ (Sheet)</a>
          </div>
        </aside>

        <div id="loader" class="loader">
          <div style="font-size: 30px; margin-bottom: 10px;">â³</div>
          Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ù† Google Sheets ...
        </div>
        <div id="error" class="loader" style="display:none;color:var(--color-danger)"></div>
      </div>

      <footer>Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠÙ‚Ø±Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Google Sheets â€” Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø´ÙŠØª Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙˆØ±Ù‹Ø§.</footer>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="box">
      <div class="close">Ø¥ØºÙ„Ø§Ù‚ <span class="icon">âœ•</span></div>
      <img id="modalImg" src="" alt="Preview" />
    </div>
  </div>

  <script>
    /***************************************************
     * âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙÙ‚Ø· Ù„Ùˆ Ø§Ø­ØªØ¬Øª       *
     ***************************************************/
    // ** ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ ÙˆÙŠÙØ±Ø¬Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª JSON Ù…Ù† Google Sheet **
    const SHEET_JSON = "https://opensheet.elk.sh/1zO6S4g2aCpZ4CXrpkXNWn_Aifmhozo-mwOr3CGH5rpc/Sheet1";
    
    const urlParams = new URLSearchParams(window.location.search);
    // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
    const QUERY_KEYS = ['id', 'unit', 'Unit', 'UnitID', 'Unit No', 'unitnumber'];

    // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© ÙÙŠ Ø§Ù„Ø´ÙŠØª (Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹)
    const MAPPING_KEYS = {
        unit: ['Unit', 'unit', 'UNIT', 'Unit #', 'AssetID', 'Asset ID', 'UnitNumber', 'Unit No'],
        systemName: ['System', 'system', 'System Name', 'Name', 'Asset Name'],
        photo: ['ImageURL', 'Image Url', 'Image', 'Photo', 'image', 'imageurl'],
        checklist: ['Checklist', 'ChecklistURL', 'Checklist URL', 'Checklist Image', 'ChecklistImage'],
        rigsite: ['RigSite', 'Rig Site', 'RigSiteURL', 'Rig Site Image', 'RigSiteImage'],
        video: ['VideoLink', 'Video Link', 'Video', 'video', 'VideoURL', 'Video URL'],
        status: ['Ready', 'Status', 'State', 'Ready?', 'status'],
        location: ['Location', 'Site', 'location'],
        lastInspection: ['LastInspection', 'Last Check', 'Last Checked', 'LastCheck', 'Last Inspection'],
    };

    // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    const COMPONENT_KEYWORDS = ['Loadcell', 'Load Cell', 'Encoder', 'DumpValve', 'Dump Valve', 'Controller', 'PowerSupply', 'Power Supply', 'Cables', 'Cable', 'System', 'Valve', 'Pump', 'Sensor'];


    // ------------------------------------------------------------------------------------------------
    // ğŸ’¡ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Helpers)
    // ------------------------------------------------------------------------------------------------
    
    /**
     * ÙŠØ­Ø¯Ø¯ ÙØ¦Ø© ÙˆÙ„ÙˆÙ† Ø§Ù„Ø´Ø§Ø±Ø© (Badge) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†Øµ Ø§Ù„Ø­Ø§Ù„Ø©
     * @param {string} text - Ù†Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø´ÙŠØª
     * @returns {{cls: string, txt: string}}
     */
    function makeBadge(text){
        const t = String(text || "").toLowerCase().trim();
        if(/^(good|ok|yes|ready|green|true|working|operational)$/i.test(t) || t.includes('good') || t.includes('ok')) {
            return {cls:'green', txt: text};
        }
        if(/^(warn|needs|check|pending|yellow|attention)$/i.test(t) || t.includes('warn') || t.includes('check')) {
            return {cls:'yellow', txt: text};
        }
        if(/^(fault|faulty|bad|no|fail|damag|error|red|broken|down)$/i.test(t) || t.includes('fault') || t.includes('bad') || t.includes('fail')) {
            return {cls:'red', txt: text};
        }
        return {cls:'yellow', txt: text || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'};
    }

    /**
     * ÙŠØ³ØªØ±Ø¬Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¢Ù…Ù†Ø© Ù…Ù† ÙƒØ§Ø¦Ù† Ø§Ù„ØµÙ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©
     * @param {Object} obj - ØµÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Row Object)
     * @param {string[]} keys - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© Ù„Ù„Ø¨Ø­Ø«
     * @returns {string|null} Ø§Ù„Ù‚ÙŠÙ…Ø© Ø£Ùˆ null Ø¥Ø°Ø§ Ù„Ù… ØªÙØ¹Ø«Ø± Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© ØºÙŠØ± ÙØ§Ø±ØºØ©
     */
    function safeGet(obj, keys){
        for(const k of keys){
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ÙØªØ§Ø­ Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ§Ù„Ù‚ÙŠÙ…Ø© ØºÙŠØ± ÙØ§Ø±ØºØ©
            if(obj.hasOwnProperty(k) && String(obj[k] || '').trim() !== ''){
                return String(obj[k]).trim();
            }
        }
        return null;
    }

    /**
     * ÙŠÙØªØ­ Ø¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚
     * @param {string} url - Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©
     */
    function openModalWith(url){
        if(!url) return;
        const modal = document.getElementById('modal');
        const img = document.getElementById('modalImg');
        img.src = url;
        modal.classList.add('open');
    }
    
    function closeModal(){
        const modal = document.getElementById('modal');
        modal.classList.remove('open');
        // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù€ src Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ­Ø±ÙŠÙƒ
        setTimeout(() => {
            document.getElementById('modalImg').src = '';
        }, 300);
    }

    // ------------------------------------------------------------------------------------------------
    // ğŸ–¼ï¸ Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UI Rendering)
    // ------------------------------------------------------------------------------------------------
    
    /**
     * ÙŠØ¹Ø±Ø¶ Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
     * @param {Array<{name: string, value: string}>} comps - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
     */
    function renderComponents(comps) {
        const area = document.getElementById('componentsArea');
        area.innerHTML = '';
        const iconMap = {'loadcell':'âš–ï¸', 'encoder':'ğŸ”¢', 'valve':'ğŸ’§', 'controller':'ğŸ§ ', 'power':'âš¡', 'cable':'ğŸ”Œ', 'pump':'âš™ï¸', 'sensor':'ğŸŒ¡ï¸', 'system':'ğŸ–¥ï¸'};
        
        for(const c of comps){
            const st = makeBadge(c.value);
            const div = document.createElement('div');
            div.className = `comp-item ${st.cls}`;
            
            // ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ø³ÙŠØ·Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù…
            let icon = 'ğŸ”§';
            const nameLower = c.name.toLowerCase();
            for(const key in iconMap) {
                if(nameLower.includes(key)) {
                    icon = iconMap[key];
                    break;
                }
            }
            
            div.innerHTML = `
                <div class="name">${icon} ${c.name}</div>
                <div class="state ${st.cls}">${st.txt || String(c.value || '-')}</div>
            `;
            area.appendChild(div);
        }
    }

    /**
     * ÙŠØ¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
     * @param {Object} found - ØµÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹
     */
    function renderDetailTable(found) {
        const table = document.getElementById('tableArea');
        table.style.display='block';
        table.innerHTML = '';
        
        // Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ ØªØ®Ø·ÙŠÙ‡Ø§ Ù„Ø£Ù†Ù‡Ø§ Ù…Ø¹Ø±ÙˆØ¶Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±
        const skipKeys = Object.values(MAPPING_KEYS).flat();
        
        for(const k of Object.keys(found)){
            const kLower = k.toLowerCase().trim();
            // ØªØ®Ø·ÙŠ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªÙŠ ØªÙ… Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„Ù€ Meta Ø£Ùˆ Ø§Ù„Ù€ Components Ø£Ùˆ Ø§Ù„Ù€ Actions
            if(skipKeys.some(sk => k.toLowerCase().includes(sk.toLowerCase())) || 
               COMPONENT_KEYWORDS.some(ck => kLower.includes(ck.toLowerCase()))) {
                continue;
            }
            
            const val = found[k];
            if(!val || String(val).trim() === '') continue;

            const row = document.createElement('div');
            row.className = 'table-row';
            
            const t = document.createElement('div');
            t.className='col-title';
            t.innerText = k;
            
            const v = document.createElement('div');
            v.className='col-val';
            
            const valStr = String(val);
            
            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„ØµÙˆØ± ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø©
            if(valStr.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)){
                const a = document.createElement('a');
                a.href = '#';
                a.innerText = 'Ø¹Ø±Ø¶ ØµÙˆØ±Ø© ğŸ–¼ï¸';
                a.onclick = (e) => { e.preventDefault(); openModalWith(valStr); };
                v.appendChild(a);
            } else if(valStr.startsWith('http')){
                const a = document.createElement('a');
                a.href = valStr;
                a.target='_blank';
                a.innerText = 'ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ğŸ”—';
                v.appendChild(a);
            } else {
                v.innerText = valStr;
            }
            
            row.appendChild(t);
            row.appendChild(v);
            table.appendChild(row);
        }
    }

    // ------------------------------------------------------------------------------------------------
    // ğŸš€ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Main Logic)
    // ------------------------------------------------------------------------------------------------
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ù€ ID Ù…Ù† URL
    let queryId = null;
    for (const key of QUERY_KEYS) {
        const val = urlParams.get(key);
        if (val) {
            queryId = val;
            break;
        }
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§
    fetch(SHEET_JSON)
      .then(r => {
        if(!r.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø´ÙŠØª. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø§Ø¨Ø· OpenSheet.');
        return r.json();
      })
      .then(rows => {
        if(!rows || rows.length === 0) throw new Error('Ø§Ù„Ø´ÙŠØª ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª.');

        let found = null;
        if(queryId){
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù€ ID ÙÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
            const idCandidates = MAPPING_KEYS.unit.concat(QUERY_KEYS);
            for(const row of rows){
                for(const key of idCandidates){
                    const val = String(row[key] || '').trim();
                    if(val === queryId){
                        found = row;
                        break;
                    }
                }
                if(found) break;
            }
        } else {
            // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ID ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ Ø¹Ø±Ø¶ Ø£ÙˆÙ„ ØµÙ
            found = rows[0];
        }

        if(!found){
            throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø§Ù„Ø±Ù‚Ù… ${queryId} ÙÙŠ Ø§Ù„Ø´ÙŠØª.`);
        }

        // 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø³ØªØ®Ù„Ø§ØµÙ‡Ø§
        const get = (keyName) => safeGet(found, MAPPING_KEYS[keyName]);
        
        const unit = get('unit') || '';
        const systemName = get('systemName') || 'Asset';
        const photo = get('photo') || '';
        const checklist = get('checklist') || '';
        const rigsite = get('rigsite') || '';
        const video = get('video') || '';
        const status = get('status') || '';
        const location = get('location') || '';
        const lastInspection = get('lastInspection') || '';

        // 2. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
        const comps = [];
        const usedKeys = new Set();
        const compKeysLower = COMPONENT_KEYWORDS.map(k => k.toLowerCase());

        for(const k of Object.keys(found)){
            const kLower = k.toLowerCase().trim();
            if(usedKeys.has(k)) continue;

            for(const cnameLower of compKeysLower){
                if(kLower.includes(cnameLower)){
                    const val = String(found[k] || '').trim();
                    if(val !== ''){
                        // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ Ù„ÙŠØ³ Ù…Ù† Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù€ Meta Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        if (!Object.values(MAPPING_KEYS).flat().includes(k)) {
                           comps.push({name: k, value: val});
                           usedKeys.add(k);
                        }
                        break;
                    }
                }
            }
        }
        
        // 3. Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        document.getElementById('loader').style.display='none';
        document.querySelector('.main').style.display='block';
        document.querySelector('.side').style.display='block';

        document.getElementById('assetTitle').innerText = systemName + (unit ? ` (${unit})` : '');
        const b = makeBadge(status);
        const statusBadge = document.getElementById('statusBadge');
        statusBadge.className = 'badge ' + b.cls;
        statusBadge.innerText = b.txt || 'Unknown';

        document.getElementById('metaUnit').innerText = unit || '--';
        document.getElementById('metaLocation').innerText = location || '--';
        document.getElementById('metaLast').innerText = lastInspection || '--';
        
        const assetPhoto = document.getElementById('assetPhoto');
        assetPhoto.src = photo || '';

        renderComponents(comps);
        renderDetailTable(found);

        // 4. Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        
        // ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
        assetPhoto.addEventListener('click', () => openModalWith(assetPhoto.src));

        // ÙØªØ­ Checklist
        document.getElementById('openChecklist').addEventListener('click', function(){
            if(!checklist){
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Checklist ÙÙŠ Ø§Ù„Ø´ÙŠØª');
                return;
            }
            openModalWith(checklist);
        });

        // ÙØªØ­ Rig Site
        document.getElementById('openRig').addEventListener('click', function(){
            if(!rigsite){
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Rig Site ÙÙŠ Ø§Ù„Ø´ÙŠØª');
                return;
            }
            openModalWith(rigsite);
        });

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        const videoBtn = document.getElementById('openVideo');
        if(video){
            videoBtn.style.display='inline-block';
            videoBtn.href = video;
        }

        // ÙØªØ­ Ø§Ù„Ø´ÙŠØª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        // ** Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„ÙŠØ·Ø§Ø¨Ù‚ Ø±Ø§Ø¨Ø· Ø§Ù„Ø´ÙŠØª Ø§Ù„ÙØ¹Ù„ÙŠ **
        document.getElementById('openExternal').href = "https://docs.google.com/spreadsheets/d/1zO6S4g2aCpZ4CXrpkXNWn_Aifmhozo-mwOr3CGH5rpc/edit"; 

      })
      .catch(err => {
        // 5. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        document.getElementById('loader').style.display='none';
        document.getElementById('error').style.display='block';
        document.getElementById('error').innerText = 'Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (err.message || err);
        console.error('Error:', err);
      });

    // ------------------------------------------------------------------------------------------------
    // ğŸŒ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù€ Modal
    // ------------------------------------------------------------------------------------------------
    
    // Modal event handlers
    document.getElementById('modal').addEventListener('click', function(e){
      if(e.target === this) closeModal();
    });
    document.querySelector('.modal .close').addEventListener('click', closeModal);
    window.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeModal(); });
  </script>
</body>
</html>
