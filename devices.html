<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JAM Maintenance Team - Device</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --primary-light: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --card-bg: #ffffff;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
      --radius: 12px;
      --radius-lg: 16px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Tajawal', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container { max-width: 1200px; margin: 0 auto; }

    .header-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-xl);
      border: 1px solid rgba(255, 255, 255, 0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 120px;
    }

    .combined-logo-wrapper { width: 100%; max-width: 550px; display: flex; justify-content: center; }
    .combined-logo-wrapper img { width: 100%; height: auto; object-fit: contain; }

    .state-box {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 60px 30px;
      text-align: center;
      box-shadow: var(--shadow-xl);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      gap: 10px;
    }

    .loader {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 5px solid rgba(37, 99, 235, 0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .state-text { font-size: 16px; color: var(--text-secondary); font-weight: 500; }
    .error-icon { font-size: 48px; color: var(--danger); }

    .content-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 24px;
    }
    @media (max-width: 1024px) {
      .content-grid { grid-template-columns: 1fr; }
      .sidebar { order: -1; }
    }

    .main-panel {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 32px;
      box-shadow: var(--shadow-xl);
      position: relative;
    }

    .asset-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
      padding-bottom: 24px;
      border-bottom: 2px solid var(--border);
      margin-bottom: 24px;
    }

    .asset-title { font-size: 28px; font-weight: 900; color: var(--text-primary); flex: 1; min-width: 200px; }

    .status-badge {
      padding: 10px 20px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 14px;
      box-shadow: var(--shadow);
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .status-badge.green { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .status-badge.yellow { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
    .status-badge.red { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }

    .meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .meta-card {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .meta-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .meta-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      word-break: break-word;
    }

    .section-title {
      font-size: 20px;
      font-weight: 900;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-title::before {
      content: '';
      width: 4px;
      height: 24px;
      background: linear-gradient(180deg, var(--primary), var(--primary-dark));
      border-radius: 2px;
    }

    .components-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
      margin-bottom: 32px;
    }

    .component-card {
      background: white;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .component-name { font-weight: 800; color: var(--text-primary); font-size: 15px; }
    .component-status {
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 800;
      font-size: 12px;
      white-space: nowrap;
    }
    .component-status.green { background: #d1fae5; color: #065f46; }
    .component-status.yellow { background: #fef3c7; color: #92400e; }
    .component-status.red { background: #fee2e2; color: #991b1b; }

    .details-table {
      background: #f8fafc;
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
      margin-bottom: 14px;
    }

    .detail-row {
      display: flex;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    .detail-row:last-child { border-bottom: none; }

    .detail-label {
      width: 200px;
      font-weight: 800;
      color: var(--text-secondary);
      font-size: 14px;
      flex-shrink: 0;
    }
    .detail-value {
      flex: 1;
      color: var(--text-primary);
      font-weight: 600;
      word-break: break-word;
    }
    .detail-value a { color: var(--primary); text-decoration: none; font-weight: 900; }
    .detail-value a:hover { text-decoration: underline; }

    .sidebar { display: flex; flex-direction: column; gap: 20px; }
    .image-card, .actions-card { background: var(--card-bg); border-radius: var(--radius-lg); padding: 20px; box-shadow: var(--shadow-xl); }

    .device-type-box {
      padding: 0 0 16px 0;
      margin-bottom: 16px;
      border-bottom: 2px solid var(--primary-light);
      text-align: center;
      display: none;
    }
    .device-type-name { font-size: 24px; font-weight: 900; color: var(--primary-dark); }
    .device-type-unit { font-size: 14px; font-weight: 800; color: var(--text-secondary); margin-top: 4px; }

    .asset-image-wrapper {
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      aspect-ratio: 4/3;
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      cursor: pointer;
    }
    .asset-image { width: 100%; height: 100%; object-fit: cover; display: none; }
    .image-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      font-size: 16px;
      color: var(--text-muted);
      font-weight: 700;
    }

    .actions-grid { display: flex; flex-direction: column; gap: 12px; }

    .action-btn {
      padding: 16px 20px;
      border-radius: var(--radius);
      border: none;
      font-weight: 900;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
      font-family: 'Tajawal', sans-serif;
    }
    .action-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .action-btn.primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
    .action-btn.success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .action-btn.danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal.open { display: flex; }

    .modal-content {
      max-width: 1200px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .modal-close {
      align-self: flex-end;
      background: white;
      color: var(--text-primary);
      padding: 12px 24px;
      border-radius: var(--radius);
      font-weight: 900;
      cursor: pointer;
      border: none;
      box-shadow: var(--shadow-lg);
      font-family: 'Tajawal', sans-serif;
      font-size: 14px;
    }

    .modal-image {
      width: 100%;
      height: auto;
      max-height: 80vh;
      object-fit: contain;
      border-radius: var(--radius);
      box-shadow: var(--shadow-xl);
      background: white;
      display: none;
    }

    .footer {
      text-align: center;
      padding: 24px;
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      font-weight: 600;
      margin-top: 24px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
    }

    @media (max-width: 768px) {
      body { padding: 12px; }
      .header-card { padding: 16px; min-height: 100px; }
      .combined-logo-wrapper { max-width: 90%; }
      .main-panel { padding: 20px; }
      .asset-title { font-size: 20px; }
      .components-grid { grid-template-columns: 1fr; }
      .detail-row { flex-direction: column; gap: 8px; }
      .detail-label { width: 100%; }
      .device-type-name { font-size: 20px; }
    }

    /* âœ… Report Modal Styles */
    .report-modal-box{
      background: #fff;
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 640px;
      box-shadow: var(--shadow-xl);
      padding: 18px 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .report-title{ font-size: 18px; font-weight: 900; color: var(--text-primary); margin: 0; }
    .report-hint{ font-size: 13px; color: var(--text-secondary); margin: 0; line-height: 1.6; }
    .report-textarea{
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-family: 'Tajawal', sans-serif;
      font-size: 14px;
      outline: none;
      resize: vertical;
    }
    .report-textarea:focus{ border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.15); }
    .report-note{ font-size: 12px; color: var(--text-muted); margin: 0; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header-card">
      <div class="combined-logo-wrapper">
        <img src="https://i.ibb.co/ZR4bYj5C/21451b26-6e0c-42d0-b0f5-ee9b71771b3a-removalai-preview.png" alt="JAM Maintenance Team">
      </div>
    </div>

    <div id="loadingState" class="state-box">
      <div class="loader"></div>
      <div class="state-text">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ù† Google Sheets...</div>
    </div>

    <div id="errorState" class="state-box" style="display:none;">
      <div class="error-icon">âš ï¸</div>
      <div class="state-text" id="errorMessage"></div>
    </div>

    <div id="mainContent" class="content-grid" style="display:none;">
      <div class="main-panel">
        <div class="asset-header">
          <h2 class="asset-title" id="assetTitle">--</h2>
          <div class="status-badge yellow" id="statusBadge">--</div>
        </div>

        <div class="meta-grid">
          <div class="meta-card">
            <div class="meta-label">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</div>
            <div class="meta-value" id="metaUnit">--</div>
          </div>
          <div class="meta-card">
            <div class="meta-label">Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
            <div class="meta-value" id="metaLocation">--</div>
          </div>
          <div class="meta-card">
            <div class="meta-label">Ø¢Ø®Ø± ÙØ­Øµ</div>
            <div class="meta-value" id="metaLast">--</div>
          </div>
        </div>

        <h3 class="section-title">Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
        <div class="components-grid" id="componentsArea"></div>

        <div id="detailsSection" style="display:none;">
          <h3 class="section-title">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©</h3>
          <div class="details-table" id="detailsTable"></div>
        </div>
      </div>

      <aside class="sidebar">
        <div class="image-card">
          <div class="device-type-box" id="deviceTypeBox">
            <p class="device-type-name" id="deviceTypeName">--</p>
            <p class="device-type-unit" id="deviceTypeUnit">Unit: --</p>
          </div>

          <div class="asset-image-wrapper" id="imageWrapper">
            <img class="asset-image" id="assetImage" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²" />
            <div class="image-placeholder" id="imagePlaceholder">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>
          </div>
        </div>

        <div class="actions-card">
          <div class="actions-grid">
            <!-- âœ… Ø²Ø± Ø§Ù„Ø¨Ù„Ø§Øº -->
            <button class="action-btn danger" id="btnReport">ğŸš¨ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</button>

            <button class="action-btn primary" id="btnChecklist">ğŸ“‹ Ø¹Ø±Ø¶ Checklist</button>
            <button class="action-btn success" id="btnRigSite">ğŸ—ï¸ Ø¹Ø±Ø¶ Rig Site</button>
            <a class="action-btn danger" id="btnVideo" href="#" target="_blank" style="display:none;">â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>
          </div>
        </div>
      </aside>
    </div>

    <div class="footer">
      JAM Inspection System for JAM devices monitoring & tracking. Developed by JAM Maintenance Team.
    </div>
  </div>

  <!-- âœ… Modal Ø§Ù„ØµÙˆØ± (Loader + Error) -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="modalClose">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>

      <div id="modalLoader" class="state-box" style="min-height:220px; padding:30px; display:none;">
        <div class="loader"></div>
        <div class="state-text">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...</div>
      </div>

      <div id="modalImgError" class="state-box" style="min-height:220px; padding:30px; display:none;">
        <div class="error-icon">âš ï¸</div>
        <div class="state-text">
          ØªØ¹Ø°Ù‘Ø± Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Public.
        </div>
      </div>

      <img class="modal-image" id="modalImage" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©" />
    </div>
  </div>

  <!-- âœ… Report Modal -->
  <div id="reportModal" class="modal" aria-hidden="true">
    <div class="report-modal-box" role="dialog" aria-modal="true" aria-labelledby="reportTitle">
      <button class="modal-close" id="reportClose">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
      <h3 class="report-title" id="reportTitle">ğŸš¨ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</h3>
      <p class="report-hint">Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ±/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø¯Ø§Ø®Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.</p>
      <textarea id="problemDescription" class="report-textarea" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§..."></textarea>
      <p class="report-note">ğŸ“ Ø¨Ø¹Ø¯ ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ±/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.</p>
      <button class="action-btn danger" id="sendReportBtn">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¹Ø¨Ø± WhatsApp</button>
    </div>
  </div>

  <script>
    // =========================
    // Settings
    // =========================
    const SHEET_JSON = "https://opensheet.elk.sh/1zO6S4g2aCpZ4CXrpkXNWn_Aifmhozo-mwOr3CGH5rpc/Sheet1";
    const WHATSAPP_NUMBER = "201201586229";

    const urlParams = new URLSearchParams(window.location.search);
    const queryId = urlParams.get('id') || urlParams.get('unit') || urlParams.get('Unit');

    // =========================
    // Helpers
    // =========================
    function safeGet(obj, keys) {
      for (const k of keys) {
        const val = obj[k];
        if (val !== null && val !== undefined && String(val).trim() !== '') return String(val).trim();
      }
      return null;
    }

    function normalizeId(v){
      const s = String(v ?? '').trim().toLowerCase();
      if (/^\d+$/.test(s)) return String(parseInt(s, 10));
      return s;
    }

    function classifyStatus(text) {
      if (!text) return { cls: 'yellow', txt: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' };
      const t = String(text).toLowerCase().trim();

      if (t.match(/^(good|ok|yes|ready|green|true|working|operational|Ø¬ÙŠØ¯|Ø¬Ø§Ù‡Ø²|Ù†Ø¹Ù…|ÙŠØ¹Ù…Ù„)$/i)
          || t.includes('good') || t.includes('ok') || t.includes('Ø¬ÙŠØ¯') || t.includes('Ø¬Ø§Ù‡Ø²'))
        return { cls: 'green', txt: text };

      if (t.match(/^(fault|faulty|bad|no|fail|damag|error|red|broken|down|ØªØ§Ù„Ù|Ø®Ø·Ø£|Ù„Ø§|Ù…Ø¹Ø·Ù„)$/i)
          || t.includes('fault') || t.includes('bad') || t.includes('fail') || t.includes('ØªØ§Ù„Ù'))
        return { cls: 'red', txt: text };

      return { cls: 'yellow', txt: text };
    }

    function showError(message) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('errorState').style.display = 'flex';
      document.getElementById('errorMessage').textContent = message;
    }

    function isProbablyImageUrl(url){
      if (!url) return false;
      const u = String(url).trim().toLowerCase();
      if (/\.(jpg|jpeg|png|gif|bmp|webp|tiff|svg)([?#].*)?$/i.test(u)) return true;
      if (u.includes('drive.google.com')) return true;
      if (u.includes('lh3.googleusercontent.com')) return true;
      if (u.includes('i.ibb.co') || u.includes('ibb.co')) return true;
      if (u.includes('imgur.com')) return true;
      return false;
    }

    function toDirectImageUrl(url){
      if (!url) return url;
      let u = String(url).trim();
      try { u = encodeURI(u); } catch(e){}

      const driveMatch = u.match(/drive\.google\.com\/file\/d\/([^\/]+)\//i);
      if (driveMatch && driveMatch[1]) return `https://drive.google.com/uc?export=view&id=${driveMatch[1]}`;

      const driveIdMatch =
        u.match(/drive\.google\.com\/open\?id=([^&]+)/i) ||
        u.match(/drive\.google\.com\/uc\?id=([^&]+)/i);

      if (driveIdMatch && driveIdMatch[1]) return `https://drive.google.com/uc?export=view&id=${driveIdMatch[1]}`;
      return u;
    }

    // =========================
    // Modal (Images)
    // =========================
    function openModal(url) {
      if (!url) return;
      if (/\.pdf([?#].*)?$/i.test(url)) { window.open(url, '_blank'); return; }

      const modal = document.getElementById('modal');
      const img = document.getElementById('modalImage');
      const loader = document.getElementById('modalLoader');
      const errBox = document.getElementById('modalImgError');

      const finalUrl = toDirectImageUrl(url);

      img.style.display = 'none';
      errBox.style.display = 'none';
      loader.style.display = 'flex';

      modal.classList.add('open');
      document.body.style.overflow = 'hidden';

      img.onload = () => {
        loader.style.display = 'none';
        errBox.style.display = 'none';
        img.style.display = 'block';
      };

      img.onerror = () => {
        loader.style.display = 'none';
        img.style.display = 'none';
        errBox.style.display = 'flex';
      };

      const bust = (finalUrl.includes('?') ? '&' : '?') + 'v=' + Date.now();
      img.src = finalUrl + bust;
    }

    function closeModal() {
      const modal = document.getElementById('modal');
      const img = document.getElementById('modalImage');
      const loader = document.getElementById('modalLoader');
      const errBox = document.getElementById('modalImgError');

      modal.classList.remove('open');
      document.body.style.overflow = '';
      loader.style.display = 'none';
      errBox.style.display = 'none';
      img.style.display = 'none';
      setTimeout(() => { img.src = ''; }, 100);
    }

    document.getElementById('modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
    document.getElementById('modalClose').addEventListener('click', closeModal);

    // =========================
    // Report Modal
    // =========================
    const reportModal = document.getElementById('reportModal');
    const btnReport = document.getElementById('btnReport');
    const reportClose = document.getElementById('reportClose');
    const sendReportBtn = document.getElementById('sendReportBtn');
    const problemDescription = document.getElementById('problemDescription');

    // current device vars
    let currentDevice = '';
    let currentUnit = '';
    let currentLocation = '';
    let currentStatus = '';
    let currentLastCheck = '';

    function openReportModal() {
      reportModal.classList.add('open');
      reportModal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      setTimeout(() => problemDescription?.focus(), 50);
    }

    function closeReportModal() {
      reportModal.classList.remove('open');
      reportModal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      if (problemDescription) problemDescription.value = '';
    }

    btnReport.addEventListener('click', openReportModal);
    reportClose.addEventListener('click', closeReportModal);
    reportModal.addEventListener('click', (e) => { if (e.target === e.currentTarget) closeReportModal(); });

    sendReportBtn.addEventListener('click', () => {
      const desc = (problemDescription.value || '').trim();
      if (!desc) { alert('âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.'); return; }

      const lines = [
        'ğŸš¨ QR Inspection â€“ Problem Report',
        '',
        `Device: ${currentDevice || '--'}`,
        `Unit: ${currentUnit || '--'}`,
        `Location: ${currentLocation || '--'}`,
        `Status: ${currentStatus || '--'}`,
        `Last Inspection: ${currentLastCheck || '--'}`,
        `Page: ${window.location.href}`,
        '',
        'Problem Description:',
        desc,
        '',
        'ğŸ“ Please attach photos/video before sending.'
      ];

      const message = encodeURIComponent(lines.join('\n'));
      window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${message}`, '_blank');
      closeReportModal();
    });

    // Escape closes modals
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
        closeReportModal();
      }
    });

    // =========================
    // Fetch & Render
    // =========================
    fetch(SHEET_JSON)
      .then(r => { if (!r.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Google Sheets.'); return r.json(); })
      .then(rows => {
        if (!rows || rows.length === 0) throw new Error('Ø§Ù„Ø´ÙŠØª ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª');

        const idKeys = ['Unit', 'unit', 'UNIT', 'AssetID', 'Asset ID', 'ID', 'id'];
        let asset = null;

        if (queryId) {
          const q = normalizeId(queryId);
          asset = rows.find(row => idKeys.some(k => normalizeId(row[k]) === q));
        } else {
          asset = rows[0];
        }

        if (!asset) throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø§Ù„Ø±Ù‚Ù…: ${queryId || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}.`);

        const unit = safeGet(asset, idKeys) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const systemName = safeGet(asset, ['System', 'system', 'System Name', 'Name', 'Asset Name']) || 'Ø¬Ù‡Ø§Ø²';

        const photo = safeGet(asset, ['ImageURL', 'Image Url', 'Image', 'Photo', 'image']);
        const checklist = safeGet(asset, ['Checklist', 'ChecklistURL', 'Checklist URL', 'Checklist Image']);
        const rigsite = safeGet(asset, ['RigSite', 'Rig Site', 'RigSiteURL', 'Rig Site Image']);
        const video = safeGet(asset, ['VideoLink', 'Video Link', 'Video', 'video', 'VideoURL']);

        const ready = safeGet(asset, ['Ready', 'Status', 'State', 'status']) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const location = safeGet(asset, ['Location', 'Site', 'location']) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const lastCheck = safeGet(asset, ['LastInspection', 'Last Check', 'Last Checked', 'LastCheck', 'Last Inspection']) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const deviceType = safeGet(asset, ['Name', 'name', 'Type', 'type']);

        // âœ… fill current vars for report
        currentDevice = (deviceType || systemName || '--');
        currentUnit = (unit || '--');
        currentLocation = (location || '--');
        currentStatus = (ready || '--');
        currentLastCheck = (lastCheck || '--');

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('mainContent').style.display = 'grid';

        const primaryName = deviceType || systemName;
        document.getElementById('assetTitle').textContent =
          unit && unit !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' ? `${primaryName} (${unit})` : primaryName;

        const st = classifyStatus(ready);
        const badge = document.getElementById('statusBadge');
        badge.className = `status-badge ${st.cls}`;
        badge.textContent = st.txt;

        document.getElementById('metaUnit').textContent = unit;
        document.getElementById('metaLocation').textContent = location;
        document.getElementById('metaLast').textContent = lastCheck;

        // Device type box
        const typeBox = document.getElementById('deviceTypeBox');
        if (deviceType) {
          typeBox.style.display = 'block';
          document.getElementById('deviceTypeName').textContent = deviceType;
          document.getElementById('deviceTypeUnit').textContent = `Unit: ${unit}`;
        } else {
          typeBox.style.display = 'none';
        }

        // Image
        const img = document.getElementById('assetImage');
        const placeholder = document.getElementById('imagePlaceholder');
        const wrapper = document.getElementById('imageWrapper');

        if (photo) {
          const direct = toDirectImageUrl(photo);
          img.src = direct;
          img.style.display = 'block';
          placeholder.style.display = 'none';
          wrapper.onclick = () => openModal(photo);

          img.onerror = () => {
            img.style.display = 'none';
            placeholder.style.display = 'flex';
            wrapper.onclick = null;
          };
        } else {
          img.style.display = 'none';
          placeholder.style.display = 'flex';
          wrapper.onclick = null;
        }

        // Components
        const componentKeys = ['Loadcell','Load Cell','Encoder','DumpValve','Dump Valve','Controller','PowerSupply','Power Supply','Cables','Cable','System','Valve','Sensor','Pump'];
        const mainAssetKeys = ['Unit','System','Location','Status','Ready','LastInspection','ImageURL','Checklist','RigSite','VideoLink','Photo','ID','Name','Type'];

        const components = [];
        Object.keys(asset).forEach(key => {
          const keyLower = key.toLowerCase();
          const isComponent = componentKeys.some(comp => keyLower.includes(comp.toLowerCase()));
          const isMainKey = mainAssetKeys.some(mk => keyLower.includes(mk.toLowerCase()));
          if (isComponent && !isMainKey) {
            const val = asset[key];
            if (val !== null && val !== undefined && String(val).trim() !== '') components.push({ name: key, value: val });
          }
        });

        const compArea = document.getElementById('componentsArea');
        compArea.innerHTML = '';
        if (components.length) {
          components.forEach(c => {
            const card = document.createElement('div');
            card.className = 'component-card';

            const name = document.createElement('div');
            name.className = 'component-name';
            name.textContent = c.name;

            const status = document.createElement('div');
            status.className = 'component-status';
            const si = classifyStatus(c.value);
            status.classList.add(si.cls);
            status.textContent = si.txt;

            card.appendChild(name);
            card.appendChild(status);
            compArea.appendChild(card);
          });
        } else {
          compArea.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text-muted);font-weight:700;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒÙˆÙ†Ø§Øª Ù…Ø­Ø¯Ø¯Ø©.</div>';
        }

        // Details
        const detailsTable = document.getElementById('detailsTable');
        detailsTable.innerHTML = '';
        let hasDetails = false;

        Object.keys(asset).forEach(key => {
          const keyLower = key.toLowerCase();
          const shouldSkip = mainAssetKeys.some(sk => keyLower.includes(sk.toLowerCase())) || components.some(c => c.name === key);
          if (shouldSkip) return;

          const val = asset[key];
          if (!val || String(val).trim() === '') return;

          hasDetails = true;

          const row = document.createElement('div');
          row.className = 'detail-row';

          const label = document.createElement('div');
          label.className = 'detail-label';
          label.textContent = key;

          const value = document.createElement('div');
          value.className = 'detail-value';

          const v = String(val).trim();
          if (v.startsWith('http') && isProbablyImageUrl(v) && !/\.pdf([?#].*)?$/i.test(v)) {
            const a = document.createElement('a');
            a.href = '#';
            a.textContent = 'ğŸ–¼ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©';
            a.onclick = (e) => { e.preventDefault(); openModal(v); };
            value.appendChild(a);
          } else if (v.startsWith('http')) {
            const a = document.createElement('a');
            a.href = v;
            a.target = '_blank';
            a.textContent = v.length > 50 ? v.substring(0, 50) + '...' : v;
            value.appendChild(a);
          } else {
            value.textContent = v;
          }

          row.appendChild(label);
          row.appendChild(value);
          detailsTable.appendChild(row);
        });

        if (hasDetails) document.getElementById('detailsSection').style.display = 'block';

        // âœ… Checklist / RigSite Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙÙ‚Ø·
        document.getElementById('btnChecklist').onclick = () => {
          if (!checklist) return alert('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Checklist ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          openModal(checklist);
        };

        document.getElementById('btnRigSite').onclick = () => {
          if (!rigsite) return alert('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Rig Site ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          openModal(rigsite);
        };

        // Video
        const btnVideo = document.getElementById('btnVideo');
        if (video) {
          btnVideo.style.display = 'flex';
          btnVideo.href = video;
        }
      })
      .catch(err => {
        console.error(err);
        showError(err.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹');
      });
  </script>
</body>
</html> <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JAM Maintenance Team - Device</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --primary-light: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --card-bg: #ffffff;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
      --radius: 12px;
      --radius-lg: 16px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Tajawal', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container { max-width: 1200px; margin: 0 auto; }

    .header-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-xl);
      border: 1px solid rgba(255, 255, 255, 0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 120px;
    }

    .combined-logo-wrapper { width: 100%; max-width: 550px; display: flex; justify-content: center; }
    .combined-logo-wrapper img { width: 100%; height: auto; object-fit: contain; }

    .state-box {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 60px 30px;
      text-align: center;
      box-shadow: var(--shadow-xl);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      gap: 10px;
    }

    .loader {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 5px solid rgba(37, 99, 235, 0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .state-text { font-size: 16px; color: var(--text-secondary); font-weight: 500; }
    .error-icon { font-size: 48px; color: var(--danger); }

    .content-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 24px;
    }
    @media (max-width: 1024px) {
      .content-grid { grid-template-columns: 1fr; }
      .sidebar { order: -1; }
    }

    .main-panel {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 32px;
      box-shadow: var(--shadow-xl);
      position: relative;
    }

    .asset-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
      padding-bottom: 24px;
      border-bottom: 2px solid var(--border);
      margin-bottom: 24px;
    }

    .asset-title { font-size: 28px; font-weight: 900; color: var(--text-primary); flex: 1; min-width: 200px; }

    .status-badge {
      padding: 10px 20px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 14px;
      box-shadow: var(--shadow);
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .status-badge.green { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .status-badge.yellow { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
    .status-badge.red { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }

    .meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .meta-card {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .meta-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .meta-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      word-break: break-word;
    }

    .section-title {
      font-size: 20px;
      font-weight: 900;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-title::before {
      content: '';
      width: 4px;
      height: 24px;
      background: linear-gradient(180deg, var(--primary), var(--primary-dark));
      border-radius: 2px;
    }

    .components-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
      margin-bottom: 32px;
    }

    .component-card {
      background: white;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .component-name { font-weight: 800; color: var(--text-primary); font-size: 15px; }
    .component-status {
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 800;
      font-size: 12px;
      white-space: nowrap;
    }
    .component-status.green { background: #d1fae5; color: #065f46; }
    .component-status.yellow { background: #fef3c7; color: #92400e; }
    .component-status.red { background: #fee2e2; color: #991b1b; }

    .details-table {
      background: #f8fafc;
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
      margin-bottom: 14px;
    }

    .detail-row {
      display: flex;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    .detail-row:last-child { border-bottom: none; }

    .detail-label {
      width: 200px;
      font-weight: 800;
      color: var(--text-secondary);
      font-size: 14px;
      flex-shrink: 0;
    }
    .detail-value {
      flex: 1;
      color: var(--text-primary);
      font-weight: 600;
      word-break: break-word;
    }
    .detail-value a { color: var(--primary); text-decoration: none; font-weight: 900; }
    .detail-value a:hover { text-decoration: underline; }

    .sidebar { display: flex; flex-direction: column; gap: 20px; }
    .image-card, .actions-card { background: var(--card-bg); border-radius: var(--radius-lg); padding: 20px; box-shadow: var(--shadow-xl); }

    .device-type-box {
      padding: 0 0 16px 0;
      margin-bottom: 16px;
      border-bottom: 2px solid var(--primary-light);
      text-align: center;
      display: none;
    }
    .device-type-name { font-size: 24px; font-weight: 900; color: var(--primary-dark); }
    .device-type-unit { font-size: 14px; font-weight: 800; color: var(--text-secondary); margin-top: 4px; }

    .asset-image-wrapper {
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      aspect-ratio: 4/3;
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      cursor: pointer;
    }
    .asset-image { width: 100%; height: 100%; object-fit: cover; display: none; }
    .image-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      font-size: 16px;
      color: var(--text-muted);
      font-weight: 700;
    }

    .actions-grid { display: flex; flex-direction: column; gap: 12px; }

    .action-btn {
      padding: 16px 20px;
      border-radius: var(--radius);
      border: none;
      font-weight: 900;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
      font-family: 'Tajawal', sans-serif;
    }
    .action-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .action-btn.primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
    .action-btn.success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .action-btn.danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal.open { display: flex; }

    .modal-content {
      max-width: 1200px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .modal-close {
      align-self: flex-end;
      background: white;
      color: var(--text-primary);
      padding: 12px 24px;
      border-radius: var(--radius);
      font-weight: 900;
      cursor: pointer;
      border: none;
      box-shadow: var(--shadow-lg);
      font-family: 'Tajawal', sans-serif;
      font-size: 14px;
    }

    .modal-image {
      width: 100%;
      height: auto;
      max-height: 80vh;
      object-fit: contain;
      border-radius: var(--radius);
      box-shadow: var(--shadow-xl);
      background: white;
      display: none;
    }

    .footer {
      text-align: center;
      padding: 24px;
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      font-weight: 600;
      margin-top: 24px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
    }

    @media (max-width: 768px) {
      body { padding: 12px; }
      .header-card { padding: 16px; min-height: 100px; }
      .combined-logo-wrapper { max-width: 90%; }
      .main-panel { padding: 20px; }
      .asset-title { font-size: 20px; }
      .components-grid { grid-template-columns: 1fr; }
      .detail-row { flex-direction: column; gap: 8px; }
      .detail-label { width: 100%; }
      .device-type-name { font-size: 20px; }
    }

    /* âœ… Report Modal Styles */
    .report-modal-box{
      background: #fff;
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 640px;
      box-shadow: var(--shadow-xl);
      padding: 18px 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .report-title{ font-size: 18px; font-weight: 900; color: var(--text-primary); margin: 0; }
    .report-hint{ font-size: 13px; color: var(--text-secondary); margin: 0; line-height: 1.6; }
    .report-textarea{
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-family: 'Tajawal', sans-serif;
      font-size: 14px;
      outline: none;
      resize: vertical;
    }
    .report-textarea:focus{ border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.15); }
    .report-note{ font-size: 12px; color: var(--text-muted); margin: 0; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header-card">
      <div class="combined-logo-wrapper">
        <img src="https://i.ibb.co/ZR4bYj5C/21451b26-6e0c-42d0-b0f5-ee9b71771b3a-removalai-preview.png" alt="JAM Maintenance Team">
      </div>
    </div>

    <div id="loadingState" class="state-box">
      <div class="loader"></div>
      <div class="state-text">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ù† Google Sheets...</div>
    </div>

    <div id="errorState" class="state-box" style="display:none;">
      <div class="error-icon">âš ï¸</div>
      <div class="state-text" id="errorMessage"></div>
    </div>

    <div id="mainContent" class="content-grid" style="display:none;">
      <div class="main-panel">
        <div class="asset-header">
          <h2 class="asset-title" id="assetTitle">--</h2>
          <div class="status-badge yellow" id="statusBadge">--</div>
        </div>

        <div class="meta-grid">
          <div class="meta-card">
            <div class="meta-label">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</div>
            <div class="meta-value" id="metaUnit">--</div>
          </div>
          <div class="meta-card">
            <div class="meta-label">Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
            <div class="meta-value" id="metaLocation">--</div>
          </div>
          <div class="meta-card">
            <div class="meta-label">Ø¢Ø®Ø± ÙØ­Øµ</div>
            <div class="meta-value" id="metaLast">--</div>
          </div>
        </div>

        <h3 class="section-title">Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
        <div class="components-grid" id="componentsArea"></div>

        <div id="detailsSection" style="display:none;">
          <h3 class="section-title">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©</h3>
          <div class="details-table" id="detailsTable"></div>
        </div>
      </div>

      <aside class="sidebar">
        <div class="image-card">
          <div class="device-type-box" id="deviceTypeBox">
            <p class="device-type-name" id="deviceTypeName">--</p>
            <p class="device-type-unit" id="deviceTypeUnit">Unit: --</p>
          </div>

          <div class="asset-image-wrapper" id="imageWrapper">
            <img class="asset-image" id="assetImage" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²" />
            <div class="image-placeholder" id="imagePlaceholder">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>
          </div>
        </div>

        <div class="actions-card">
          <div class="actions-grid">
            <!-- âœ… Ø²Ø± Ø§Ù„Ø¨Ù„Ø§Øº -->
            <button class="action-btn danger" id="btnReport">ğŸš¨ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</button>

            <button class="action-btn primary" id="btnChecklist">ğŸ“‹ Ø¹Ø±Ø¶ Checklist</button>
            <button class="action-btn success" id="btnRigSite">ğŸ—ï¸ Ø¹Ø±Ø¶ Rig Site</button>
            <a class="action-btn danger" id="btnVideo" href="#" target="_blank" style="display:none;">â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>
          </div>
        </div>
      </aside>
    </div>

    <div class="footer">
      JAM Inspection System for JAM devices monitoring & tracking. Developed by JAM Maintenance Team.
    </div>
  </div>

  <!-- âœ… Modal Ø§Ù„ØµÙˆØ± (Loader + Error) -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="modalClose">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>

      <div id="modalLoader" class="state-box" style="min-height:220px; padding:30px; display:none;">
        <div class="loader"></div>
        <div class="state-text">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...</div>
      </div>

      <div id="modalImgError" class="state-box" style="min-height:220px; padding:30px; display:none;">
        <div class="error-icon">âš ï¸</div>
        <div class="state-text">
          ØªØ¹Ø°Ù‘Ø± Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Public.
        </div>
      </div>

      <img class="modal-image" id="modalImage" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©" />
    </div>
  </div>

  <!-- âœ… Report Modal -->
  <div id="reportModal" class="modal" aria-hidden="true">
    <div class="report-modal-box" role="dialog" aria-modal="true" aria-labelledby="reportTitle">
      <button class="modal-close" id="reportClose">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
      <h3 class="report-title" id="reportTitle">ğŸš¨ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</h3>
      <p class="report-hint">Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ±/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø¯Ø§Ø®Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.</p>
      <textarea id="problemDescription" class="report-textarea" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§..."></textarea>
      <p class="report-note">ğŸ“ Ø¨Ø¹Ø¯ ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ±/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.</p>
      <button class="action-btn danger" id="sendReportBtn">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¹Ø¨Ø± WhatsApp</button>
    </div>
  </div>

  <script>
    // =========================
    // Settings
    // =========================
    const SHEET_JSON = "https://opensheet.elk.sh/1zO6S4g2aCpZ4CXrpkXNWn_Aifmhozo-mwOr3CGH5rpc/Sheet1";
    const WHATSAPP_NUMBER = "201202696247";

    const urlParams = new URLSearchParams(window.location.search);
    const queryId = urlParams.get('id') || urlParams.get('unit') || urlParams.get('Unit');

    // =========================
    // Helpers
    // =========================
    function safeGet(obj, keys) {
      for (const k of keys) {
        const val = obj[k];
        if (val !== null && val !== undefined && String(val).trim() !== '') return String(val).trim();
      }
      return null;
    }

    function normalizeId(v){
      const s = String(v ?? '').trim().toLowerCase();
      if (/^\d+$/.test(s)) return String(parseInt(s, 10));
      return s;
    }

    function classifyStatus(text) {
      if (!text) return { cls: 'yellow', txt: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' };
      const t = String(text).toLowerCase().trim();

      if (t.match(/^(good|ok|yes|ready|green|true|working|operational|Ø¬ÙŠØ¯|Ø¬Ø§Ù‡Ø²|Ù†Ø¹Ù…|ÙŠØ¹Ù…Ù„)$/i)
          || t.includes('good') || t.includes('ok') || t.includes('Ø¬ÙŠØ¯') || t.includes('Ø¬Ø§Ù‡Ø²'))
        return { cls: 'green', txt: text };

      if (t.match(/^(fault|faulty|bad|no|fail|damag|error|red|broken|down|ØªØ§Ù„Ù|Ø®Ø·Ø£|Ù„Ø§|Ù…Ø¹Ø·Ù„)$/i)
          || t.includes('fault') || t.includes('bad') || t.includes('fail') || t.includes('ØªØ§Ù„Ù'))
        return { cls: 'red', txt: text };

      return { cls: 'yellow', txt: text };
    }

    function showError(message) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('errorState').style.display = 'flex';
      document.getElementById('errorMessage').textContent = message;
    }

    function isProbablyImageUrl(url){
      if (!url) return false;
      const u = String(url).trim().toLowerCase();
      if (/\.(jpg|jpeg|png|gif|bmp|webp|tiff|svg)([?#].*)?$/i.test(u)) return true;
      if (u.includes('drive.google.com')) return true;
      if (u.includes('lh3.googleusercontent.com')) return true;
      if (u.includes('i.ibb.co') || u.includes('ibb.co')) return true;
      if (u.includes('imgur.com')) return true;
      return false;
    }

    function toDirectImageUrl(url){
      if (!url) return url;
      let u = String(url).trim();
      try { u = encodeURI(u); } catch(e){}

      const driveMatch = u.match(/drive\.google\.com\/file\/d\/([^\/]+)\//i);
      if (driveMatch && driveMatch[1]) return `https://drive.google.com/uc?export=view&id=${driveMatch[1]}`;

      const driveIdMatch =
        u.match(/drive\.google\.com\/open\?id=([^&]+)/i) ||
        u.match(/drive\.google\.com\/uc\?id=([^&]+)/i);

      if (driveIdMatch && driveIdMatch[1]) return `https://drive.google.com/uc?export=view&id=${driveIdMatch[1]}`;
      return u;
    }

    // =========================
    // Modal (Images)
    // =========================
    function openModal(url) {
      if (!url) return;
      if (/\.pdf([?#].*)?$/i.test(url)) { window.open(url, '_blank'); return; }

      const modal = document.getElementById('modal');
      const img = document.getElementById('modalImage');
      const loader = document.getElementById('modalLoader');
      const errBox = document.getElementById('modalImgError');

      const finalUrl = toDirectImageUrl(url);

      img.style.display = 'none';
      errBox.style.display = 'none';
      loader.style.display = 'flex';

      modal.classList.add('open');
      document.body.style.overflow = 'hidden';

      img.onload = () => {
        loader.style.display = 'none';
        errBox.style.display = 'none';
        img.style.display = 'block';
      };

      img.onerror = () => {
        loader.style.display = 'none';
        img.style.display = 'none';
        errBox.style.display = 'flex';
      };

      const bust = (finalUrl.includes('?') ? '&' : '?') + 'v=' + Date.now();
      img.src = finalUrl + bust;
    }

    function closeModal() {
      const modal = document.getElementById('modal');
      const img = document.getElementById('modalImage');
      const loader = document.getElementById('modalLoader');
      const errBox = document.getElementById('modalImgError');

      modal.classList.remove('open');
      document.body.style.overflow = '';
      loader.style.display = 'none';
      errBox.style.display = 'none';
      img.style.display = 'none';
      setTimeout(() => { img.src = ''; }, 100);
    }

    document.getElementById('modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
    document.getElementById('modalClose').addEventListener('click', closeModal);

    // =========================
    // Report Modal
    // =========================
    const reportModal = document.getElementById('reportModal');
    const btnReport = document.getElementById('btnReport');
    const reportClose = document.getElementById('reportClose');
    const sendReportBtn = document.getElementById('sendReportBtn');
    const problemDescription = document.getElementById('problemDescription');

    // current device vars
    let currentDevice = '';
    let currentUnit = '';
    let currentLocation = '';
    let currentStatus = '';
    let currentLastCheck = '';

    function openReportModal() {
      reportModal.classList.add('open');
      reportModal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      setTimeout(() => problemDescription?.focus(), 50);
    }

    function closeReportModal() {
      reportModal.classList.remove('open');
      reportModal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      if (problemDescription) problemDescription.value = '';
    }

    btnReport.addEventListener('click', openReportModal);
    reportClose.addEventListener('click', closeReportModal);
    reportModal.addEventListener('click', (e) => { if (e.target === e.currentTarget) closeReportModal(); });

    sendReportBtn.addEventListener('click', () => {
      const desc = (problemDescription.value || '').trim();
      if (!desc) { alert('âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.'); return; }

      const lines = [
        'ğŸš¨ QR Inspection â€“ Problem Report',
        '',
        `Device: ${currentDevice || '--'}`,
        `Unit: ${currentUnit || '--'}`,
        `Location: ${currentLocation || '--'}`,
        `Status: ${currentStatus || '--'}`,
        `Last Inspection: ${currentLastCheck || '--'}`,
        `Page: ${window.location.href}`,
        '',
        'Problem Description:',
        desc,
        '',
        'ğŸ“ Please attach photos/video before sending.'
      ];

      const message = encodeURIComponent(lines.join('\n'));
      window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${message}`, '_blank');
      closeReportModal();
    });

    // Escape closes modals
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
        closeReportModal();
      }
    });

    // =========================
    // Fetch & Render
    // =========================
    fetch(SHEET_JSON)
      .then(r => { if (!r.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Google Sheets.'); return r.json(); })
      .then(rows => {
        if (!rows || rows.length === 0) throw new Error('Ø§Ù„Ø´ÙŠØª ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª');

        const idKeys = ['Unit', 'unit', 'UNIT', 'AssetID', 'Asset ID', 'ID', 'id'];
        let asset = null;

        if (queryId) {
          const q = normalizeId(queryId);
          asset = rows.find(row => idKeys.some(k => normalizeId(row[k]) === q));
        } else {
          asset = rows[0];
        }

        if (!asset) throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø§Ù„Ø±Ù‚Ù…: ${queryId || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}.`);

        const unit = safeGet(asset, idKeys) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const systemName = safeGet(asset, ['System', 'system', 'System Name', 'Name', 'Asset Name']) || 'Ø¬Ù‡Ø§Ø²';

        const photo = safeGet(asset, ['ImageURL', 'Image Url', 'Image', 'Photo', 'image']);
        const checklist = safeGet(asset, ['Checklist', 'ChecklistURL', 'Checklist URL', 'Checklist Image']);
        const rigsite = safeGet(asset, ['RigSite', 'Rig Site', 'RigSiteURL', 'Rig Site Image']);
        const video = safeGet(asset, ['VideoLink', 'Video Link', 'Video', 'video', 'VideoURL']);

        const ready = safeGet(asset, ['Ready', 'Status', 'State', 'status']) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const location = safeGet(asset, ['Location', 'Site', 'location']) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const lastCheck = safeGet(asset, ['LastInspection', 'Last Check', 'Last Checked', 'LastCheck', 'Last Inspection']) || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const deviceType = safeGet(asset, ['Name', 'name', 'Type', 'type']);

        // âœ… fill current vars for report
        currentDevice = (deviceType || systemName || '--');
        currentUnit = (unit || '--');
        currentLocation = (location || '--');
        currentStatus = (ready || '--');
        currentLastCheck = (lastCheck || '--');

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('mainContent').style.display = 'grid';

        const primaryName = deviceType || systemName;
        document.getElementById('assetTitle').textContent =
          unit && unit !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' ? `${primaryName} (${unit})` : primaryName;

        const st = classifyStatus(ready);
        const badge = document.getElementById('statusBadge');
        badge.className = `status-badge ${st.cls}`;
        badge.textContent = st.txt;

        document.getElementById('metaUnit').textContent = unit;
        document.getElementById('metaLocation').textContent = location;
        document.getElementById('metaLast').textContent = lastCheck;

        // Device type box
        const typeBox = document.getElementById('deviceTypeBox');
        if (deviceType) {
          typeBox.style.display = 'block';
          document.getElementById('deviceTypeName').textContent = deviceType;
          document.getElementById('deviceTypeUnit').textContent = `Unit: ${unit}`;
        } else {
          typeBox.style.display = 'none';
        }

        // Image
        const img = document.getElementById('assetImage');
        const placeholder = document.getElementById('imagePlaceholder');
        const wrapper = document.getElementById('imageWrapper');

        if (photo) {
          const direct = toDirectImageUrl(photo);
          img.src = direct;
          img.style.display = 'block';
          placeholder.style.display = 'none';
          wrapper.onclick = () => openModal(photo);

          img.onerror = () => {
            img.style.display = 'none';
            placeholder.style.display = 'flex';
            wrapper.onclick = null;
          };
        } else {
          img.style.display = 'none';
          placeholder.style.display = 'flex';
          wrapper.onclick = null;
        }

        // Components
        const componentKeys = ['Loadcell','Load Cell','Encoder','DumpValve','Dump Valve','Controller','PowerSupply','Power Supply','Cables','Cable','System','Valve','Sensor','Pump'];
        const mainAssetKeys = ['Unit','System','Location','Status','Ready','LastInspection','ImageURL','Checklist','RigSite','VideoLink','Photo','ID','Name','Type'];

        const components = [];
        Object.keys(asset).forEach(key => {
          const keyLower = key.toLowerCase();
          const isComponent = componentKeys.some(comp => keyLower.includes(comp.toLowerCase()));
          const isMainKey = mainAssetKeys.some(mk => keyLower.includes(mk.toLowerCase()));
          if (isComponent && !isMainKey) {
            const val = asset[key];
            if (val !== null && val !== undefined && String(val).trim() !== '') components.push({ name: key, value: val });
          }
        });

        const compArea = document.getElementById('componentsArea');
        compArea.innerHTML = '';
        if (components.length) {
          components.forEach(c => {
            const card = document.createElement('div');
            card.className = 'component-card';

            const name = document.createElement('div');
            name.className = 'component-name';
            name.textContent = c.name;

            const status = document.createElement('div');
            status.className = 'component-status';
            const si = classifyStatus(c.value);
            status.classList.add(si.cls);
            status.textContent = si.txt;

            card.appendChild(name);
            card.appendChild(status);
            compArea.appendChild(card);
          });
        } else {
          compArea.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text-muted);font-weight:700;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒÙˆÙ†Ø§Øª Ù…Ø­Ø¯Ø¯Ø©.</div>';
        }

        // Details
        const detailsTable = document.getElementById('detailsTable');
        detailsTable.innerHTML = '';
        let hasDetails = false;

        Object.keys(asset).forEach(key => {
          const keyLower = key.toLowerCase();
          const shouldSkip = mainAssetKeys.some(sk => keyLower.includes(sk.toLowerCase())) || components.some(c => c.name === key);
          if (shouldSkip) return;

          const val = asset[key];
          if (!val || String(val).trim() === '') return;

          hasDetails = true;

          const row = document.createElement('div');
          row.className = 'detail-row';

          const label = document.createElement('div');
          label.className = 'detail-label';
          label.textContent = key;

          const value = document.createElement('div');
          value.className = 'detail-value';

          const v = String(val).trim();
          if (v.startsWith('http') && isProbablyImageUrl(v) && !/\.pdf([?#].*)?$/i.test(v)) {
            const a = document.createElement('a');
            a.href = '#';
            a.textContent = 'ğŸ–¼ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©';
            a.onclick = (e) => { e.preventDefault(); openModal(v); };
            value.appendChild(a);
          } else if (v.startsWith('http')) {
            const a = document.createElement('a');
            a.href = v;
            a.target = '_blank';
            a.textContent = v.length > 50 ? v.substring(0, 50) + '...' : v;
            value.appendChild(a);
          } else {
            value.textContent = v;
          }

          row.appendChild(label);
          row.appendChild(value);
          detailsTable.appendChild(row);
        });

        if (hasDetails) document.getElementById('detailsSection').style.display = 'block';

        // âœ… Checklist / RigSite Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙÙ‚Ø·
        document.getElementById('btnChecklist').onclick = () => {
          if (!checklist) return alert('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Checklist ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          openModal(checklist);
        };

        document.getElementById('btnRigSite').onclick = () => {
          if (!rigsite) return alert('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Rig Site ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          openModal(rigsite);
        };

        // Video
        const btnVideo = document.getElementById('btnVideo');
        if (video) {
          btnVideo.style.display = 'flex';
          btnVideo.href = video;
        }
      })
      .catch(err => {
        console.error(err);
        showError(err.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹');
      });
  </script>
</body>
</html>
